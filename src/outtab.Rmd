```{r outtab, cache=cacheon}
survfunc <- function(time, event, time1 = NULL, time2 = NULL, eventcomp, eventname,
                     datacross = NULL, norep = TRUE,
                     timedep = norep, fg = norep) {
  tmpnrow <- 4
  if (timedep) {
    tmpnrow <- tmpnrow + 1
  }
  if (fg) {
    tmpnrow <- tmpnrow + 1
  }

  out <- data.frame(matrix(NA, ncol = 6, nrow = tmpnrow))

  out[1, 1] <- eventname
  colnames(out) <- c("Outcome", "Model", rep(c("SGLT2 No", "SGLT2 Yes"), 2))

  ## incidence rate
  out[1, 2] <- "Incidence"

  incfunc <- function(data) {
    if (norep) {
      ev <- data %>%
        group_by(sos_ddr_sglt2) %>%
        summarise(
          ev = sum(!!sym(event) == "Yes"),
          .groups = "drop"
        )
    }
    if (!norep) {
      ev <- data %>%
        group_by(sos_ddr_sglt2) %>%
        summarise(
          ev = sum(!!sym(event)),
          .groups = "drop"
        )
    }

    s <- data %>%
      group_by(sos_ddr_sglt2) %>%
      summarise(
        s = sum(!!sym(time) / 365.25),
        .groups = "drop"
      )
    r <- pois.exact(x = ev$ev, pt = s$s / 100)

    return(paste0(
      ev$ev, ", ",
      fn(s$s, dig = 0), ", ",
      fn(r$rate, dig = 0), " (",
      fn(r$lower, dig = 0), "-",
      fn(r$upper, dig = 0), ")"
    ))
  }

  out[1, 3:4] <- incfunc(data = rsdata)
  out[1, 5:6] <- incfunc(matchrsdata)

  ## cox regressions
  if (norep) {
    # all
    # crude
    mod <- coxph(formula(paste0("Surv(", time, ",", event, "=='Yes') ~ sos_ddr_sglt2")),
      data = rsdata
    )
    smod <- summary(mod)
    out[2, 2] <- "Crude HR (95% CI), p-value"
    out[2, 3:4] <- c("ref", paste0(
      fn(smod$conf.int[1, 1], dig = 2),
      " (", fn(smod$conf.int[1, 3], dig = 2),
      "-", fn(smod$conf.int[1, 4], dig = 2), "), ",
      fn(smod$coef[1, 5], dig = 3, p = TRUE)
    ))

    # adjusted individual covariates
    amod <- with(imprsdata, coxph(formula(paste0(
      "Surv(", time, ",", event, " == 'Yes') ~ sos_ddr_sglt2 +",
      paste(modvarsstrata, collapse = " + ")
    ))))

    asmod <- summary(pool(amod))

    out[3, 2] <- "Adj (ind vars) HR (95% CI), p-value"
    out[3, 3:4] <- c("ref", paste0(
      fn(exp(asmod$estimate[1]), dig = 2),
      " (", fn(exp(asmod$estimate[1] - global_z05 * asmod$std.error[1]), dig = 2),
      "-", fn(exp(asmod$estimate[1] + global_z05 * asmod$std.error[1]), dig = 2), "), ",
      fn(asmod$p.value[1], dig = 3, p = TRUE)
    ))

    # adjusted ps
    mod <- coxph(formula(paste0("Surv(", time, ",", event, "=='Yes') ~ sos_ddr_sglt2 + ns(ps, 4)")),
      data = rsdata
    )
    smod <- summary(mod)
    out[4, 2] <- "Adj (ps) HR (95% CI), p-value"
    out[4, 3:4] <- c("ref", paste0(
      fn(smod$conf.int[1, 1], dig = 2),
      " (", fn(smod$conf.int[1, 3], dig = 2),
      "-", fn(smod$conf.int[1, 4], dig = 2), "), ",
      fn(smod$coef[1, 5], dig = 3, p = TRUE)
    ))

    # matched
    mod <- coxph(formula(paste0("Surv(", time, ",", event, "=='Yes') ~ sos_ddr_sglt2 + frailty.gaussian(par)")),
      data = matchrsdata
    )
    smod <- summary(mod)

    out[4, 5:6] <- c("ref", paste0(
      fn(smod$conf.int[1, 1], dig = 2),
      " (", fn(smod$conf.int[1, 3], dig = 2),
      "-", fn(smod$conf.int[1, 4], dig = 2), "), ",
      fn(smod$coef[1, "p"], dig = 3, p = TRUE)
    ))

    if (timedep) {
      out[5, 2] <- "Adj HR (95% CI), p-value, sglt2i as time dependent"

      mod <- coxph(formula(paste0("Surv(start, stop,", event, "=='Yes') ~ sos_ddr_sglt2 + frailty.gaussian(par)")),
        data = datacross
      )

      smod <- summary(mod)

      out[5, 5:6] <- c("ref", paste0(
        fn(smod$conf.int[1, 1], dig = 2),
        " (", fn(smod$conf.int[1, 3], dig = 2),
        "-", fn(smod$conf.int[1, 4], dig = 2), "), ",
        fn(smod$coef[1, "p"], dig = 3, p = TRUE)
      ))
    }
    if (fg) {
      out[6, 2] <- "Adj HR (95% CI), p-value, death as competing event"

      mod <- summary(z <- crr(matchrsdata %>% pull(!!sym(time)),
        matchrsdata %>% pull(!!sym(eventcomp)),
        matchrsdata %>% pull(sos_ddr_sglt2num),
        failcode = 1, cencode = 0
      ))

      # P-value
      p <- fn(mod$coef[, 5], dig = 3, p = TRUE)

      out[6, 5:6] <- c("ref", paste0(
        fn(mod$conf.int[, 1], dig = 2),
        " (", fn(mod$conf.int[, 3], dig = 2),
        "-", fn(mod$conf.int[, 4], dig = 2), ") ",
        p
      ))
    }
  }
  if (!norep) {
    # neg bin regression
    out[2, 2] <- "Crude RR (95% CI), p-value"

    ## crude
    mod <- summary(glm.nb(formula(paste0(event, " ~ sos_ddr_sglt2 + offset(log(sos_outtime_death))")),
      data = rsdata %>% filter(sos_outtime_death > 0)
    ))

    out[2, 3:4] <- c("ref", paste0(
      fn(exp(mod$coefficients[2, 1]), dig = 2),
      " (", fn(exp(mod$coefficients[2, 1] - global_z05 * mod$coefficients[2, 2]), dig = 2),
      "-", fn(exp(mod$coefficients[2, 1] + global_z05 * mod$coefficients[2, 2]), dig = 2), "), ",
      fn(mod$coefficients[2, 4], dig = 3, p = TRUE)
    ))

    # adjusted individual covariates
    amod <- with(imprsdata, glm.nb(formula(paste0(
      event, " ~ sos_ddr_sglt2 + offset(log(sos_outtime_death)) +",
      paste(modvarsstrata, collapse = " + ")
    ))))

    asmod <- summary(pool(amod))

    out[3, 2] <- "Adj (ind vars) RR (95% CI), p-value"
    out[3, 3:4] <- c("ref", paste0(
      fn(exp(asmod$estimate[2]), dig = 2),
      " (", fn(exp(asmod$estimate[2] - global_z05 * asmod$std.error[2]), dig = 2),
      "-", fn(exp(asmod$estimate[2] + global_z05 * asmod$std.error[2]), dig = 2), "), ",
      fn(asmod$p.value[2], dig = 3, p = TRUE)
    ))

    # adjusted ps
    mod <- summary(glm.nb(formula(paste0(
      event,
      " ~ sos_ddr_sglt2 + offset(log(sos_outtime_death)) + ns(ps, 4)"
    )),
    data = rsdata %>% filter(sos_outtime_death > 0)
    ))

    smod <- summary(mod)
    out[4, 2] <- "Adj (ps) RR (95% CI), p-value"

    out[4, 3:4] <- c("ref", paste0(
      fn(exp(mod$coefficients[2, 1]), dig = 2),
      " (", fn(exp(mod$coefficients[2, 1] - global_z05 * mod$coefficients[2, 2]), dig = 2),
      "-", fn(exp(mod$coefficients[2, 1] + global_z05 * mod$coefficients[2, 2]), dig = 2), "), ",
      fn(mod$coefficients[2, 4], dig = 3, p = TRUE)
    ))

    # matched
    mod <- summary(lme4::glmer.nb(formula(paste0(event, " ~
                                                     sos_ddr_sglt2 + offset(log(sos_outtime_death)) + (1 | par)")),
      data = matchrsdata
    ))
    se <- sqrt(vcov(mod)[1])

    out[4, 5:6] <- c("ref", paste0(
      fn(exp(mod$coefficients[2, 1]), dig = 2),
      " (", fn(exp(mod$coefficients[2, 1] - global_z05 * mod$coefficients[2, 2]), dig = 2),
      "-", fn(exp(mod$coefficients[2, 1] + global_z05 * mod$coefficients[2, 2]), dig = 2), "), ",
      fn(mod$coefficients[2, 4], dig = 3, p = TRUE)
    ))
  }
  return(out)
}

cvdeathhfhosp <- survfunc(
  time = "sos_outtime_hosphf",
  event = "sos_out_deathcvhosphf",
  eventname = "CVD/first HF hospitalization",
  datacross = matchcross_deathcvhosphf,
  eventcomp = "sos_out_deathcvhosphf_comp"
)
cvdeath <- survfunc(
  time = "sos_outtime_death",
  event = "sos_out_deathcv",
  eventname = "CVD",
  datacross = matchcross_deathcv,
  eventcomp = "sos_out_deathcv_comp"
)
hfhosp <- survfunc(
  time = "sos_outtime_hosphf",
  event = "sos_out_hosphf",
  eventname = "First HF hospitalization",
  datacross = matchcross_hosphf,
  eventcomp = "sos_out_hosphf_comp"
)
rephfhosp <- survfunc(
  time = "sos_outtime_death",
  event = "sos_out_counthosphf",
  eventname = "Total HF hospitalization",
  norep = FALSE
)
death <- survfunc(
  time = "sos_outtime_death",
  event = "sos_out_death",
  eventname = "All-cause mortality",
  datacross = matchcross_death,
  fg = FALSE
)
renalhosp <- survfunc(
  time = "sos_outtime_hosprenal",
  event = "sos_out_hosprenal",
  eventname = "First Renal hospitalization",
  datacross = matchcross_hosprenal,
  eventcomp = "sos_out_hosprenal_comp"
)

outall <- rbind(
  cvdeathhfhosp,
  cvdeath,
  hfhosp,
  rephfhosp,
  death,
  renalhosp
)

write.xlsx(outall, paste0("./output/tabs/Outcomes_", Sys.Date(), ".xlsx"), rowNames = FALSE)

myHeader <- c(" " = 1, " " = 1, "All" = 2, "Matched" = 2)
names(myHeader) <- c(" ", " ", "All", "Matched")


footnote(default_kable(outall,
  font_size = 6,
  caption = "Outcomes",
  longtable = TRUE
) %>%
  landscape() %>%
  add_header_above(myHeader),
general = c(
  "Incidence =  no events, sum py, rate/100py (95% CI).",
  "Adj (ind vars) = Adjusted for the individual variables indicated in the baseline table.",
  "Adj (ps) = Adjusted for the propensity scrore as a covariate using a cubic spline with 4 df in All data./Including the matched pairs as a frailty term in the Matched data."
)
)
```
